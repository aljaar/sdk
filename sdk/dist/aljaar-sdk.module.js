import{v4 as r}from"uuid";import e from"mitt";import t from"joi";function n(){return n=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},n.apply(this,arguments)}var i=e(),o=function(r){try{return Promise.resolve(r()).then(function(r){return r.error&&i.emit("aljaar:on:error",r.error),r})}catch(r){return Promise.reject(r)}},a=/^(^\+62|62|^08)(\d{3,4}-?){2}\d{3,4}$/;function u(e){var u=e.supabase,s={auth_state:null,session:null,user:null},c=u.storage.from("avatars").getPublicUrl("public/avatar.default.webp").data.publicUrl;return i.on("aljaar:on:error",function(r){console.info(r.message)}),u.auth.onAuthStateChange(function(r,e){console.log({event:r,session:e}),s.auth_state=r,e?(s.session=e,s.user=e.user):(s.session=null,s.user=null),i.emit("aljaar:on:auth",{event:r,session:e})}),{emitter:i,auth:{user:function(){try{return Promise.resolve(u.auth.getUser()).then(function(r){var e=r.data.user;return Promise.resolve(u.from("profiles").select().eq("user_id",e.id).single()).then(function(r){return e.profile=r.data,s.user=e,e})})}catch(r){return Promise.reject(r)}},signInWith:function(r){var e=r.type,t=r.credential,n=void 0===t?{}:t;switch(e){case"google":case"facebook":case"github":return o(function(){return u.auth.signInWithOAuth({provider:e})});case"email":return o(function(){return u.auth.signInWithPassword({email:n.email,password:n.password})})}},signUp:function(r){try{return Promise.resolve(o(function(){return function(r){return t.object({full_name:t.string().required(),email:t.string().email({minDomainSegments:2,tlds:{allow:["com","net"]}}).required(),password:t.string().min(8).alphanum().required(),phone:t.string().regex(a).required()}).validate(r)}(r)})).then(function(r){var e=r.value,t=r.error;return t?{data:null,error:t}:o(function(){return u.auth.signUp({email:e.email,password:e.password,options:{data:{full_name:e.full_name,avatar_url:c,phone:e.phone}}})})})}catch(r){return Promise.reject(r)}},signOut:function(){return o(function(){return u.auth.signOut()})},resetPassword:function(r){return o(function(){return u.auth.resetPasswordForEmail(r,{redirectTo:"http://localhost:3000/"})})},updateLocation:function(){return new Promise(function(r){navigator.geolocation||r({data:null,error:{message:"Can't get user current location"}}),navigator.geolocation.getCurrentPosition(function(e){var t=o(function(){return u.from("profiles").update({location:"SRID=4326;POINT("+e.coords.latitude+" "+e.coords.longitude+")"}).eq("user_id",s.user.id)});r({data:e.coords,error:t.error})},function(){},{maximumAge:6e4,timeout:5e3,enableHighAccuracy:!0})})}},user:{me:function(){},update:function(r){},getNeighborCount:function(){try{return Promise.resolve(u.rpc("get_neighbor_count",{radius:200})).then(function(r){console.log(r.data,r.error)})}catch(r){return Promise.reject(r)}},getNeighborProducts:function(){try{return Promise.resolve(u.rpc("get_neighbor_products",{radius:200})).then(function(r){console.log(r.data,r.error)})}catch(r){return Promise.reject(r)}}},product:{detail:function(r){try{return Promise.resolve(o(function(){return u.from("products").select("*, product_tags!inner ( tags (id, name) )")}).eq("id",r)).then(function(r){return r.data.map(function(r){var e=r.product_tags;return delete r.product_tags,n({},r,{images:r.images.map(function(r){return u.storage.from("products").getPublicUrl(r)}).map(function(r){return r.data.publicUrl}),tags:e.map(function(r){var e=r.tags;return{id:e.id,name:e.name}})})})})}catch(r){return Promise.reject(r)}},all:function(){try{return Promise.resolve(o(function(){var r;return u.from("products").select("*, product_images ( image ), product_tags!inner ( tags (id, name) )").eq("user_id",null==(r=s.user)?void 0:r.id)})).then(function(r){return r.data.map(function(r){var e=r.product_tags,t=r.product_images;return delete r.product_tags,delete r.product_images,n({},r,{images:t.map(function(r){var e=r.image;return u.storage.from("products").getPublicUrl(e)}).map(function(r){return r.data.publicUrl}),tags:e.map(function(r){var e=r.tags;return{id:e.id,name:e.name}})})})})}catch(r){return Promise.reject(r)}},create:function(e){var i=e.data,a=e.images;try{var c=a.map(function(e){try{var t=e.name.split(".").pop(),n=r()+"."+t;return Promise.resolve(o(function(){return u.storage.from("products").upload(s.user.id+"/"+n,e)})).then(function(r){return r.data})}catch(r){return Promise.reject(r)}});return Promise.resolve(Promise.all(c)).then(function(r){var e=r.map(function(r){return r.path}),a=i.drop_point,s=a[0],c=a[1],l=n({},i,{images:e});return Promise.resolve(o(function(){return function(r){return t.object().keys({title:t.string().min(8).label("Title").required(),description:t.string().label("Description").required(),category:t.string().valid("food","non-food").label("Category").required(),tags:t.array().items(t.number()).min(1).label("Tags").required(),drop_point:t.array().items(t.number()).label("Pick Up Point").required(),drop_time:t.array().items(t.string()).label("Pick Up Time").required(),images:t.array().items(t.string()).min(1).label("Images").required(),used_since:t.when("category",{is:t.string().valid("non-food").required(),then:t.string().label("Used Since").required()}),expired_at:t.when("category",{is:t.string().valid("food").required(),then:t.date().iso().label("Expired Date").required()})}).validate(r)}(l)})).then(function(r){var t=r.value,n=r.error;return n?{data:null,error:n}:(t.drop_point="SRID=4326;POINT("+s+" "+c+")",o(function(){return u.rpc("create_product",{product_raw:JSON.stringify(t),images:e,drop_time:i.drop_time})}))})})}catch(r){return Promise.reject(r)}},update:function(r,e){var i=e.data;try{return Promise.resolve(o(function(){return function(r){return t.object().keys({title:t.string().min(8).label("Title").optional(),description:t.string().label("Description").optional(),category:t.string().valid("food","non-food").label("Category").optional(),tags:t.array().items(t.number()).label("Tags").optional(),drop_point:t.array().items(t.number()).label("Pick Up Point").optional(),drop_time:t.array().items(t.string()).label("Pick Up Time").optional(),images:t.array().items(t.string()).label("Images").optional(),used_since:t.when("category",{is:t.string().valid("non-food").required(),then:t.string().label("Used Since").optional()}),expired_at:t.when("category",{is:t.string().valid("food").required(),then:t.date().iso().label("Expired Date").optional()})}).validate(r)}(n({},i))})).then(function(e){var t=e.value,i=e.error;if(i)return{data:null,error:i};var a=t.tags;return delete t.tags,Promise.resolve(Promise.all([o(function(){return u.rpc("add_product_tag",{p_id:r,tags:a})}),o(function(){return u.from("products").update(n({},t)).eq("id",r)})])).then(function(e){return{id:r,product:t,update:e}})})}catch(r){return Promise.reject(r)}},delete:function(r){try{return Promise.resolve(o(function(){return u.rpc("delete_product",{p_id:r})}))}catch(r){return Promise.reject(r)}}},lists:{},tags:{all:function(){return o(function(){return u.from("tags").select("id, name").limit(8)})},search:function(r){try{return Promise.resolve(o(function(){return u.from("tags").select("id, name").limit(8).ilike("name","%"+r+"%")}))}catch(r){return Promise.reject(r)}}}}}export{u as default};
//# sourceMappingURL=aljaar-sdk.module.js.map
